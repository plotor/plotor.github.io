<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/favicon_16.png?v=2.6.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/favicon_32.png?v=2.6.1" type="image/png" sizes="32x32"><meta name="google-site-verification" content="O5CNgi37yYXs3qQp7Xz61oL_AmGiwM28d7hRt5yh2to"><meta name="baidu-site-verification" content="pnKVynCWMP"><meta name="description" content="单元测试（UT: Unit Test）是保证服务质量的基础。在实际项目的 UT 开发中，我们通常需要执行第三方服务调用、连接数据库等操作，为了让 UT 能够正常运行起来，我们需要执行大量的环境准备工作，这些工作有时比 UT 本身还要费时费力很多，而 mock 机制则能够帮助我们绕开这些必要但不一定要真正需要去做的事情，隔离 UT 与服务的依赖，模拟我们期望的行为和数据。">
<meta property="og:type" content="article">
<meta property="og:title" content="JMockit：单元测试利器">
<meta property="og:url" content="https://plotor.github.io/2019/01/14/java/jmockit/index.html">
<meta property="og:site_name" content="指  间">
<meta property="og:description" content="单元测试（UT: Unit Test）是保证服务质量的基础。在实际项目的 UT 开发中，我们通常需要执行第三方服务调用、连接数据库等操作，为了让 UT 能够正常运行起来，我们需要执行大量的环境准备工作，这些工作有时比 UT 本身还要费时费力很多，而 mock 机制则能够帮助我们绕开这些必要但不一定要真正需要去做的事情，隔离 UT 与服务的依赖，模拟我们期望的行为和数据。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-01-14T07:58:16.000Z">
<meta property="article:modified_time" content="2024-12-11T11:35:23.466Z">
<meta property="article:author" content="zhenchao">
<meta property="article:tag" content="JMockit">
<meta name="twitter:card" content="summary"><title>JMockit：单元测试利器 | 指  间</title><link ref="canonical" href="https://plotor.github.io/2019/01/14/java/jmockit/"><link rel="alternate" href="/atom.xml" type="application/atom+xml"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: {"avoidBanner":false},
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user-circle"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">JMockit：单元测试利器</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-01-14</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">6.5k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">32分</span></span></div></header><div class="post-body"><p>单元测试（UT: Unit Test）是保证服务质量的基础。在实际项目的 UT 开发中，我们通常需要执行第三方服务调用、连接数据库等操作，为了让 UT 能够正常运行起来，我们需要执行大量的环境准备工作，这些工作有时比 UT 本身还要费时费力很多，而 mock 机制则能够帮助我们绕开这些必要但不一定要真正需要去做的事情，隔离 UT 与服务的依赖，模拟我们期望的行为和数据。<a id="more"></a></p>
<p>在 java 生态系统中，有多种 mock 组件可供选择，包括：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://easymock.org/">EasyMock</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>、<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://jmock.org/">JMock</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>、<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://site.mockito.org/">mockito</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>、<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://www.unitils.org/summary.html">unitils</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>、<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://www.powermock.org/">PowerMock</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，以及 <span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://jmockit.github.io/">JMockit</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>等。本文将要介绍的 JMockit 组件是众多 mock 组件中最为强大的一个。</p>
<blockquote>
<ul>
<li>jmockit version: 1.44</li>
<li>junit version: 4.12</li>
</ul>
</blockquote>

        <h3 id="录制-amp-重放-amp-验证">
          <a href="#录制-amp-重放-amp-验证" class="heading-link"><i class="fas fa-link"></i></a>录制 &amp; 重放 &amp; 验证</h3>
      <p>录制（record）、重放（replay）和验证（verify）是 JMockit 的设计哲学（下文如果不做特殊说明，均使用 RRV 进行指代），这三个步骤各自所担负的责任如下：</p>
<ul>
<li><strong>录制</strong> ：录制目标方法的期望行为，依据条件返回期望的数据，或者抛出异常。</li>
<li><strong>重放</strong> ：当执行测试逻辑时，之前录制的行为会被触发，所谓的重放是应用之前录制的行为。</li>
<li><strong>验证</strong> ：验证被测试逻辑的实际表现，例如期望的方法是否被调用，实际被调用了几次等。</li>
</ul>
<p>实际在日常使用 JUnit 进行 UT 开发时，我们通常也是按照录制、重放、验证这样一个步骤进行的，只不过我们称之为 “Arrange-Act-Assert”，3A 理论与 RRV 本质上是一样的。</p>
<p>下面的代码展示了 RRV 在编写 UT 时的具体框架：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 1. 录制</span></span><br><span class="line">    <span class="keyword">new</span> Expectations() {</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// 录制我们期望的目标方法行为</span></span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 重放：执行测试逻辑</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 验证</span></span><br><span class="line">    <span class="keyword">new</span> Verifications() {</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// 验证目标方法的执行状态</span></span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>使用 JMockit 进行实际 UT 开发时，并不要求同时提供这 3 个步骤实现，一般我们常用的是录制和重放，而业务相关的验证逻辑可以使用断言。</p>

        <h4 id="录制：Expectations">
          <a href="#录制：Expectations" class="heading-link"><i class="fas fa-link"></i></a>录制：Expectations</h4>
      <p>Expectations 代码块用于放置录制行为，录制主要分为两种方式：</p>
<ol>
<li>引用外部 mock 类或接口实例进行录制。</li>
<li>通过构造方法注入类或对象实例进行录制。</li>
</ol>

        <h5 id="引用外部-mock-类或接口实例进行录制">
          <a href="#引用外部-mock-类或接口实例进行录制" class="heading-link"><i class="fas fa-link"></i></a>引用外部 mock 类或接口实例进行录制</h5>
      <figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mocked</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordByMockedInstance</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">new</span> Expectations() {</span><br><span class="line">        {</span><br><span class="line">            userService.getUserName(anyLong);</span><br><span class="line">            result = <span class="string">"zhenchao"</span>;</span><br><span class="line"></span><br><span class="line">            userService.getUserAge(anyLong);</span><br><span class="line">            result = <span class="number">28</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    Assert.assertEquals(<span class="string">"zhenchao"</span>, userService.getUserName(<span class="number">1001L</span>));</span><br><span class="line">    Assert.assertEquals(<span class="number">28</span>, userService.getUserAge(<span class="number">1002L</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>

        <h5 id="通过构造方法注入类或对象实例进行录制">
          <a href="#通过构造方法注入类或对象实例进行录制" class="heading-link"><i class="fas fa-link"></i></a>通过构造方法注入类或对象实例进行录制</h5>
      <p>Expectations 提供了带参数的构造方法（定义如下），我们可以将一个类的 Class 对象，或者类实例对象作为参数构造 Expectations 对象，区别在于如果传递的是类 Class 对象则录制会对该类的所有实例生效，如果传递的是类实例对象则仅对当前实例生效。</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">Expectations</span><span class="params">(<span class="meta">@Nonnull</span> Object... classesOrObjectsToBePartiallyMocked)</span> </span>{</span><br><span class="line">  execution = <span class="keyword">new</span> RecordAndReplayExecution(<span class="keyword">this</span>, classesOrObjectsToBePartiallyMocked);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<ul>
<li>以类 Class 对象构造 Expectations</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordByClass</span><span class="params">()</span> </span>{</span><br><span class="line">    User user = <span class="keyword">new</span> User(<span class="number">1001L</span>);</span><br><span class="line">    <span class="keyword">new</span> Expectations(User.class) {</span><br><span class="line">        {</span><br><span class="line">            user.getName();</span><br><span class="line">            result = <span class="string">"zhenchao"</span>;</span><br><span class="line"></span><br><span class="line">            user.getAge();</span><br><span class="line">            result = <span class="number">28</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    Assert.assertEquals(<span class="string">"zhenchao"</span>, user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">28</span>, user.getAge());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对其它实例同样生效</span></span><br><span class="line">    User user2 = <span class="keyword">new</span> User(<span class="number">1002L</span>, <span class="string">"zhangsan"</span>, <span class="number">18</span>);</span><br><span class="line">    Assert.assertEquals(<span class="string">"zhenchao"</span>, user2.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">28</span>, user2.getAge());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<ul>
<li>以类对象实例构造 Expectations</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordByInstance</span><span class="params">()</span> </span>{</span><br><span class="line">    User user = <span class="keyword">new</span> User(<span class="number">1001L</span>);</span><br><span class="line">    <span class="keyword">new</span> Expectations(user) {</span><br><span class="line">        {</span><br><span class="line">            user.getName();</span><br><span class="line">            result = <span class="string">"zhenchao"</span>;</span><br><span class="line"></span><br><span class="line">            user.getAge();</span><br><span class="line">            result = <span class="number">28</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    Assert.assertEquals(<span class="string">"zhenchao"</span>, user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">28</span>, user.getAge());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对其它实例不生效</span></span><br><span class="line">    User user2 = <span class="keyword">new</span> User(<span class="number">1002L</span>, <span class="string">"zhangsan"</span>, <span class="number">18</span>);</span><br><span class="line">    Assert.assertEquals(<span class="string">"zhangsan"</span>, user2.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">18</span>, user2.getAge());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>

        <h5 id="录制多个期望时序结果">
          <a href="#录制多个期望时序结果" class="heading-link"><i class="fas fa-link"></i></a>录制多个期望时序结果</h5>
      <p>如果我们希望目标方法在被调用时，每次返回的期望结果都不一样，那么可以在录制时指定返回一个结果值数组（或列表），数组（或列表）的每个值都对应该方法被调用时期望返回的结果。示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordSequenceResult</span><span class="params">()</span> </span>{</span><br><span class="line">    User user = <span class="keyword">new</span> User(<span class="number">1001L</span>);</span><br><span class="line">    <span class="keyword">new</span> Expectations(user) {</span><br><span class="line">        {</span><br><span class="line">            user.getName();</span><br><span class="line">            result = <span class="keyword">new</span> String[] {<span class="string">"zhangsan"</span>, <span class="string">"lisi"</span>, <span class="string">"wanger"</span>};</span><br><span class="line"></span><br><span class="line">            user.getAge();</span><br><span class="line">            result = <span class="keyword">new</span> <span class="keyword">int</span>[] {<span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>};</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一次调用</span></span><br><span class="line">    Assert.assertEquals(<span class="string">"zhangsan"</span>, user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">16</span>, user.getAge());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第二次调用</span></span><br><span class="line">    Assert.assertEquals(<span class="string">"lisi"</span>, user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">17</span>, user.getAge());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第三次调用</span></span><br><span class="line">    Assert.assertEquals(<span class="string">"wanger"</span>, user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">18</span>, user.getAge());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第四次调用，因为没有录制结果，所以返回最后一次录制的期望值</span></span><br><span class="line">    Assert.assertEquals(<span class="string">"wanger"</span>, user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">18</span>, user.getAge());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>示例中我们为方法 <code>User#getName</code> 和 <code>User#getAge</code> 录制了一组返回值，然后在相应方法依次被调用时会返回对应下标的返回值，可以看到当第 4 次调用时仍然返回第 3 组值，这是因为没有为第 4 次调用录制期望值，所以继续沿用最后一组期望值。我们也可以使用 <code>returns(v1, v2, ...)</code> 方法来代替 <code>result = (...)</code> 的语法，即 <code>returns("zhangsan", "lisi", "wanger")</code> 等价于 <code>result = new String[] {"zhangsan", "lisi", "wanger"}</code> 语法。</p>

        <h5 id="条件性录制">
          <a href="#条件性录制" class="heading-link"><i class="fas fa-link"></i></a>条件性录制</h5>
      <p>上面的示例在录制期望返回值时只设定了一个具体的值，如果期望依据入参条件性设置返回值，可以使用 Delegate 接口。例如下面的示例中我们依据入参 userId 的值，条件性返回具体的用户名称：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delegate</span><span class="params">()</span> </span>{</span><br><span class="line">    UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">    <span class="keyword">new</span> Expectations(userService) {</span><br><span class="line">        {</span><br><span class="line">            userService.getUserName(anyLong);</span><br><span class="line">            result = <span class="keyword">new</span> Delegate() {</span><br><span class="line">                <span class="comment">// 方法名可以任意</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">delegate</span><span class="params">(<span class="keyword">long</span> userId)</span> </span>{</span><br><span class="line">                    <span class="keyword">return</span> userId &gt; <span class="number">1003L</span> ? <span class="string">"unknown"</span> : <span class="string">"zhenchao"</span>;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">            };</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    Assert.assertEquals(<span class="string">"zhenchao"</span>, userService.getUserName(<span class="number">1001L</span>));</span><br><span class="line">    Assert.assertEquals(<span class="string">"zhenchao"</span>, userService.getUserName(<span class="number">1002L</span>));</span><br><span class="line">    Assert.assertEquals(<span class="string">"unknown"</span>, userService.getUserName(<span class="number">1004L</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>另外一个比较经典的应用场景就是依据入参条件性的选择录制还是委托给目标方法，此时我们需要引入 Invocation 对象。示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delegate</span><span class="params">()</span> </span>{</span><br><span class="line">    UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">    <span class="keyword">new</span> Expectations(userService) {</span><br><span class="line">        {</span><br><span class="line">            userService.getUserInfo(anyLong);</span><br><span class="line">            result = <span class="keyword">new</span> Delegate() {</span><br><span class="line">                <span class="comment">// 方法名可以任意</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> User <span class="title">delegate</span><span class="params">(Invocation inv, <span class="keyword">long</span> userId)</span> </span>{</span><br><span class="line">                    <span class="keyword">if</span> (userId &gt; <span class="number">1003</span>) {</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> User(userId, <span class="string">"u_"</span> + userId, (<span class="keyword">int</span>) (userId % <span class="number">100</span>));</span><br><span class="line">                    }</span><br><span class="line">                    <span class="comment">// 对于 userId 小于等于 1003 的全部交由目标方法处理</span></span><br><span class="line">                    <span class="keyword">return</span> inv.proceed(userId);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">            };</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    Assert.assertEquals(UserServiceImpl.REGISTRY.get(<span class="number">1001L</span>), userService.getUserInfo(<span class="number">1001L</span>));</span><br><span class="line">    Assert.assertEquals(UserServiceImpl.REGISTRY.get(<span class="number">1002L</span>), userService.getUserInfo(<span class="number">1002L</span>));</span><br><span class="line">    Assert.assertEquals(UserServiceImpl.REGISTRY.get(<span class="number">1003L</span>), userService.getUserInfo(<span class="number">1003L</span>));</span><br><span class="line">    User user = userService.getUserInfo(<span class="number">1004L</span>);</span><br><span class="line">    Assert.assertEquals(<span class="number">1004L</span>, user.getId());</span><br><span class="line">    Assert.assertEquals(<span class="string">"u_1004"</span>, user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">4</span>, user.getAge());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>示例中我们对于 userId 小于等于 1003 的请求全部委托给目标方法执行。</p>

        <h5 id="灵活的参数匹配策略">
          <a href="#灵活的参数匹配策略" class="heading-link"><i class="fas fa-link"></i></a>灵活的参数匹配策略</h5>
      <p>当我们在录制期望时，对于方法的参数设置如果指定了具体的值，那么在重放测试逻辑时只能匹配对应的值，但是很多时候我们并不希望这样精确的匹配。幸运的是 JMockit 对于参数提供了灵活的匹配策略，即 any 语法和 with 语法。</p>
<ul>
<li>Any 语法</li>
</ul>
<p>通过 any 语法，我们可以匹配任意类型的参数值，示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">any</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">    <span class="keyword">new</span> Expectations(userService) {</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// 匹配任意类型为 long 的参数值</span></span><br><span class="line">            userService.getUserName(anyLong);</span><br><span class="line">            result = <span class="string">"zhenchao"</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    Assert.assertEquals(<span class="string">"zhenchao"</span>, userService.getUserName(RandomUtils.nextLong()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>示例中我们使用 anyLong 录制方法匹配任意 long 类型的参数值。此外，JMockit 还提供了以下 any 语法：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Object any = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> String anyString = <span class="keyword">new</span> String();</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Long anyLong = <span class="number">0L</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Integer anyInt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Short anyShort = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Byte anyByte = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Boolean anyBoolean = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Character anyChar = <span class="string">'\0'</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Double anyDouble = <span class="number">0.0</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Float anyFloat = <span class="number">0.0F</span>;</span><br></pre></td></tr></tbody></table></div></figure>
<ul>
<li>With 语法</li>
</ul>
<p>With 语法相对于 any 语法提供了更加灵活的匹配策略，当 any 无法满足我们的需求时，可以尝试从 with 语法中寻找解决方案。示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">with</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">    <span class="keyword">new</span> Expectations(userService) {</span><br><span class="line">        {</span><br><span class="line">            userService.batchUpdateUserInfo(<span class="keyword">this</span>.withNotNull());</span><br><span class="line">            result = <span class="number">10</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    Assert.assertEquals(<span class="number">10</span>, userService.batchUpdateUserInfo(<span class="keyword">new</span> ArrayList&lt;&gt;()));</span><br><span class="line">    <span class="comment">// 错误，参数值不允许为 null</span></span><br><span class="line">    <span class="comment">// Assert.assertEquals(10, userService.batchUpdateUserInfo(null));</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>示例中 <code>UserService#batchUpdateUserInfo</code> 方法接收一个 <code>List&lt;User&gt;</code> 类型的参数，这里我们使用了 withNotNull 方法，期望匹配任何不为 null 入参。此外，JMockit 还提供了以下类型的 with 语法：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">with</span><span class="params">(<span class="meta">@Nonnull</span> Delegate&lt;? <span class="keyword">super</span> T&gt; objectWithDelegateMethod)</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">withAny</span><span class="params">(<span class="meta">@Nonnull</span> T arg)</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">withEqual</span><span class="params">(<span class="meta">@Nonnull</span> T arg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">double</span> <span class="title">withEqual</span><span class="params">(<span class="keyword">double</span> value, <span class="keyword">double</span> delta)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">float</span> <span class="title">withEqual</span><span class="params">(<span class="keyword">float</span> value, <span class="keyword">double</span> delta)</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">withInstanceLike</span><span class="params">(<span class="meta">@Nonnull</span> T object)</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">withInstanceOf</span><span class="params">(<span class="meta">@Nonnull</span> Class&lt;T&gt; argClass)</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">withNotEqual</span><span class="params">(<span class="meta">@Nonnull</span> T arg)</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">withNull</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">withNotNull</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">T <span class="title">withSameInstance</span><span class="params">(<span class="meta">@Nonnull</span> T object)</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T extends CharSequence&gt; <span class="function">T <span class="title">withSubstring</span><span class="params">(<span class="meta">@Nonnull</span> T text)</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T extends CharSequence&gt; <span class="function">T <span class="title">withPrefix</span><span class="params">(<span class="meta">@Nonnull</span> T text)</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T extends CharSequence&gt; <span class="function">T <span class="title">withSuffix</span><span class="params">(<span class="meta">@Nonnull</span> T text)</span></span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T extends CharSequence&gt; <span class="function">T <span class="title">withMatch</span><span class="params">(<span class="meta">@Nonnull</span> T regex)</span></span>;</span><br></pre></td></tr></tbody></table></div></figure>

        <h5 id="录制方法调用次数限制">
          <a href="#录制方法调用次数限制" class="heading-link"><i class="fas fa-link"></i></a>录制方法调用次数限制</h5>
      <p>JMockit 在录制期望时提供了 <code>times</code>、<code>minTimes</code> 和 <code>maxTimes</code> 语法，用于限制当前方法被调用的次数。示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">times</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">    <span class="keyword">new</span> Expectations(userService) {</span><br><span class="line">        {</span><br><span class="line">            userService.getUserName(anyLong);</span><br><span class="line">            result = <span class="string">"zhenchao"</span>;</span><br><span class="line">            times = <span class="number">1</span>; <span class="comment">// 限制当前方法仅允许被调用 1 次</span></span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    Assert.assertEquals(<span class="string">"zhenchao"</span>, userService.getUserName(RandomUtils.nextLong()));</span><br><span class="line">    <span class="comment">// 错误，方法限制仅允许调用 1 次</span></span><br><span class="line">    <span class="comment">// Assert.assertEquals("zhenchao", userService.getUserName(RandomUtils.nextLong()));</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>

        <h4 id="验证：Verifications">
          <a href="#验证：Verifications" class="heading-link"><i class="fas fa-link"></i></a>验证：Verifications</h4>
      <p>Verifications 用于验证被测试方法调用的状态，即方法是否被调用过，调用了多少次等。Verifications 同样提供了 <code>times</code>、<code>minTimes</code> 和 <code>maxTimes</code> 语法，这与 Expectations 中的设置相同。示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mocked</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verifyForMockedInstance</span><span class="params">()</span> </span>{</span><br><span class="line">    Assert.assertNull(userService.getUserName(<span class="number">1001L</span>));</span><br><span class="line">    Assert.assertNull(userService.getUserName(<span class="number">1001L</span>));</span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, userService.getUserAge(<span class="number">1001L</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Verifications() {</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// 限定 getUserName 方法只能被调用 2 次</span></span><br><span class="line">            userService.getUserName(anyLong);</span><br><span class="line">            times = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 限定 getUserAge 方法只能被调用 1 次</span></span><br><span class="line">            userService.getUserAge(anyLong);</span><br><span class="line">            times = <span class="number">1</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verifyForInstance</span><span class="params">()</span> </span>{</span><br><span class="line">    User user = <span class="keyword">new</span> User(<span class="number">1001L</span>, <span class="string">"zhenchao"</span>, <span class="number">28</span>);</span><br><span class="line">    Assert.assertEquals(<span class="string">"zhenchao"</span>, user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">28</span>, user.getAge());</span><br><span class="line">    Assert.assertEquals(<span class="number">28</span>, user.getAge());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Verifications() {</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// 限定 getName 方法只能被调用 1 次</span></span><br><span class="line">            user.getName();</span><br><span class="line">            times = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 限定 getAge 方法只能被调用 2 次</span></span><br><span class="line">            user.getAge();</span><br><span class="line">            times = <span class="number">2</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>

        <h5 id="限制方法的调用顺序">
          <a href="#限制方法的调用顺序" class="heading-link"><i class="fas fa-link"></i></a>限制方法的调用顺序</h5>
      <p>如果期望目标方法按照一定的顺序执行，可以使用 VerificationsInOrder 代替 Verifications。示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mocked</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verifyInOrder</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 错误，方法执行顺序不满足期望</span></span><br><span class="line">    Assert.assertNull(userService.getUserName(<span class="number">1001L</span>));</span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, userService.getUserAge(<span class="number">1001L</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> VerificationsInOrder() {</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// 限定 getUserName 方法在 getUserAge 方法前执行</span></span><br><span class="line">            userService.getUserName(anyLong);</span><br><span class="line">            userService.getUserAge(anyLong);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>需要注意的是，VerificationsInOrder 对于局部实例不生效。</p>

        <h5 id="强制验证所有测试方法">
          <a href="#强制验证所有测试方法" class="heading-link"><i class="fas fa-link"></i></a>强制验证所有测试方法</h5>
      <p>如果期望所有在重放阶段调用的测试方法都需要被验证，可以使用 FullVerifications 代替 Verifications。示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mocked</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fullVerify</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// 错误，因为 getUserAge 方法并未被验证</span></span><br><span class="line">    Assert.assertNull(userService.getUserName(<span class="number">1001L</span>));</span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, userService.getUserAge(<span class="number">1001L</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> FullVerifications() {</span><br><span class="line">        {</span><br><span class="line">            userService.getUserName(anyLong);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>需要注意的是，FullVerifications 对于局部实例不生效。</p>

        <h5 id="捕获重放阶段的方法参数">
          <a href="#捕获重放阶段的方法参数" class="heading-link"><i class="fas fa-link"></i></a>捕获重放阶段的方法参数</h5>
      <p>JMockit 允许在 Verifications 代码块中通过 withCapture 方法捕获重放阶段传递的方法参数，分为 3 种情况：</p>
<ol>
<li>捕获单次方法调用的参数。</li>
<li>捕获多次方法调用的参数集合。</li>
<li>捕获方法调用时新创建的对象。</li>
</ol>
<p>具体示例如下：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">capturingSingle</span><span class="params">()</span> </span>{</span><br><span class="line">    userService.checkPassword(<span class="number">1001L</span>, <span class="string">"aaa"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Verifications() {</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// 捕获单次方法调用的参数</span></span><br><span class="line">            <span class="keyword">long</span> uid;</span><br><span class="line">            String pwd;</span><br><span class="line">            userService.checkPassword(uid = <span class="keyword">this</span>.withCapture(), pwd = <span class="keyword">this</span>.withCapture());</span><br><span class="line">            Assert.assertEquals(<span class="number">1001L</span>, uid);</span><br><span class="line">            Assert.assertEquals(<span class="string">"aaa"</span>, pwd);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">capturingMultiple</span><span class="params">()</span> </span>{</span><br><span class="line">    userService.getUserInfo(<span class="number">1001L</span>);</span><br><span class="line">    userService.getUserInfo(<span class="number">1002L</span>);</span><br><span class="line">    userService.getUserInfo(<span class="number">1003L</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Verifications() {</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// 捕获多次方法调用的参数集合</span></span><br><span class="line">            List&lt;Long&gt; userIds = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            userService.getUserInfo(<span class="keyword">this</span>.withCapture(userIds));</span><br><span class="line">            Assert.assertEquals(<span class="number">3</span>, userIds.size());</span><br><span class="line">            Assert.assertEquals(Arrays.asList(<span class="number">1001L</span>, <span class="number">1002L</span>, <span class="number">1003L</span>), userIds);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">capturingNewInstances</span><span class="params">(<span class="meta">@Mocked</span> User user)</span> </span>{ <span class="comment">// 不要忘了 @Mocked User</span></span><br><span class="line">    userService.updateUserInfo(<span class="keyword">new</span> User(<span class="number">1001L</span>, <span class="string">"zhangsan"</span>, <span class="number">16</span>));</span><br><span class="line">    userService.updateUserInfo(<span class="keyword">new</span> User(<span class="number">1002L</span>, <span class="string">"lisi"</span>, <span class="number">17</span>));</span><br><span class="line">    userService.updateUserInfo(<span class="keyword">new</span> User(<span class="number">1003L</span>, <span class="string">"wanger"</span>, <span class="number">18</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Verifications() {</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// 捕获方法调用时新创建的对象</span></span><br><span class="line">            List&lt;User&gt; users = <span class="keyword">this</span>.withCapture(<span class="keyword">new</span> User(anyLong, anyString, anyInt));</span><br><span class="line">            Assert.assertEquals(<span class="number">3</span>, users.size());</span><br><span class="line"></span><br><span class="line">            List&lt;User&gt; userInfos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            userService.updateUserInfo(<span class="keyword">this</span>.withCapture(userInfos));</span><br><span class="line"></span><br><span class="line">            Assert.assertEquals(users, userInfos);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>

        <h3 id="Mocking：模拟测试所依赖的运行环境">
          <a href="#Mocking：模拟测试所依赖的运行环境" class="heading-link"><i class="fas fa-link"></i></a>Mocking：模拟测试所依赖的运行环境</h3>
      
        <h4 id="Mock-注解的特点与使用场景">
          <a href="#Mock-注解的特点与使用场景" class="heading-link"><i class="fas fa-link"></i></a>Mock 注解的特点与使用场景</h4>
      <p>JMockit 提供了多个 mock 注解，用于模拟被测试对象所依赖的运行环境，包括 <code>@Mocked</code>、<code>@Tested</code>、<code>@Injectabe</code>、以及 <code>@Capturing</code>。这些注解可以修饰我们在测试类中声明的 <strong>mock 属性</strong> 和测试方法的 <strong>mock 参数</strong> 。被这些注解修饰的属性和参数（类型包括接口、普通类、抽象类、final 类、注解，以及枚举），JMockit 会依据相应注解的语义对其进行实例化。这几个注解的基本语义如下：</p>
<ul>
<li><code>@Mocked</code>：委托 JMockit 创建目标接口或者类的实例，所有实例都会被托管（不管是不是 JMockit 创建的），所有方法（包括静态方法、构造方法）均返回对应类型的初始值，如果是引用类型则递归初始化。</li>
<li><code>@Injectabe</code>：委托 JMockit 创建目标接口或者类的实例，仅 JMcokit 创建的实例会被托管，类实例方法（不包括静态方法、构造方法）均返回对应类型的初始值，如果是引用类型则递归初始化。</li>
<li><code>@Tested</code>：标记一个实例是被测试实例，如果能够依据类型推断出用于具体实例化的类，则 JMockit 会自动执行实例化操作，否则需要手动实例化，当我们调用实例的方法时，相应方法并不会被 JMockit 托管，但是配合 <code>@Injectabe</code> 注解，可以注入方法中使用到的依赖实例。</li>
<li><code>@Capturing</code>：委托 JMockit 代理目标接口或者父类，被代理的接口或父类不管子类如何实现（可以是人工编写、匿名类，甚至是动态代理类），其相应的方法都将被 JMockit 托管，适用于代理子类的行为，并且子类是不易描述的。</li>
</ul>

        <h5 id="注解：Mocked">
          <a href="#注解：Mocked" class="heading-link"><i class="fas fa-link"></i></a>注解：Mocked</h5>
      <p>注解 <code>@Mocked</code> 可以修饰类和接口，其语义是告诉 JMockit 生成当前被 mock 类或接口的对象，该对象的方法（包括静态方法、构造方法）均返回对应类型的初始值，例如对于 int 类型则返回 0，String 类型返回 null，如果返回类型是一个引用类型，则 JMockit 会递归创建该类型的对象，同样该对象的属性都会被设置为相应的初始值。</p>

        <h6 id="修饰接口类型">
          <a href="#修饰接口类型" class="heading-link"><i class="fas fa-link"></i></a>修饰接口类型</h6>
      <figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mocked</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mockedInterface</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// String 类型方法直接返回 null</span></span><br><span class="line">    Assert.assertNull(userService.getUserName(<span class="number">1001L</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// int 类型方法直接返回 0</span></span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, userService.getUserAge(<span class="number">1001L</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 引用类型方法返回一个新的 User 对象，但是对象的属性值都是初始值</span></span><br><span class="line">    User user = userService.getUserInfo(<span class="number">1001L</span>);</span><br><span class="line">    Assert.assertNotNull(user);</span><br><span class="line">    Assert.assertEquals(<span class="number">0L</span>, user.getId());</span><br><span class="line">    Assert.assertNull(user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, user.getAge());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>总结：</p>
<ol>
<li>注解会创建一个接口的实现类对象。</li>
<li>返回值为基本类型的方法直接返回初始值。</li>
<li>返回值为 String 类型的方法直接返回 null。</li>
<li>返回值为引用类型的方法会递归初始化。</li>
</ol>

        <h6 id="修饰类类型">
          <a href="#修饰类类型" class="heading-link"><i class="fas fa-link"></i></a>修饰类类型</h6>
      <figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mocked</span></span><br><span class="line"><span class="keyword">private</span> UserServiceImpl userServiceImpl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mockedClass</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// String 类型实例方法直接返回 null</span></span><br><span class="line">    Assert.assertNull(userService.getUserName(<span class="number">1001L</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// int 类型实例方法直接返回 0</span></span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, userService.getUserAge(<span class="number">1001L</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 引用类型方法返回一个新的 User 对象，但是对象的属性值都是初始值</span></span><br><span class="line">    User user = userService.getUserInfo(<span class="number">1001L</span>);</span><br><span class="line">    Assert.assertNotNull(user);</span><br><span class="line">    Assert.assertEquals(<span class="number">0L</span>, user.getId());</span><br><span class="line">    Assert.assertNull(user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, user.getAge());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类的静态方法也会被托管</span></span><br><span class="line">    User newUser = UserServiceImpl.newUserInfo(<span class="string">"zhenchao"</span>, <span class="number">28</span>);</span><br><span class="line">    Assert.assertEquals(<span class="number">0L</span>, newUser.getId());</span><br><span class="line">    Assert.assertNull(newUser.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, newUser.getAge());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自己 new 一个被 mock 类型对象也会被托管</span></span><br><span class="line">    UserService localService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">    Assert.assertNull(localService.getUserName(<span class="number">1001L</span>));</span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, localService.getUserAge(<span class="number">1001L</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>总结：</p>
<ol>
<li>满足接口类型所有的特点。</li>
<li>静态方法同样会被托管，效果与实例方法一样。</li>
<li>即使自己 new 出来的实例也会被托管。</li>
</ol>

        <h5 id="注解：Injectabe">
          <a href="#注解：Injectabe" class="heading-link"><i class="fas fa-link"></i></a>注解：Injectabe</h5>
      <p>注解 <code>@Injectable</code> 同样可以修饰类和接口，其语义是告诉 JMockit 生成当前被 mock 类或接口的对象。相对于 <code>@Mocked</code> 的区别在于，<code>@Injectable</code> 仅托管修饰类或接口的当前实例，而不是所有实例。此外，<code>@Injectable</code> 对类的静态方法、构造方法没有影响。修饰类的示例如下：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Injectable</span></span><br><span class="line"><span class="keyword">private</span> UserServiceImpl userServiceImpl;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">injectableClass</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// String 类型实例方法直接返回 null</span></span><br><span class="line">    Assert.assertNull(userService.getUserName(<span class="number">1001L</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// int 类型实例方法直接返回 0</span></span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, userService.getUserAge(<span class="number">1001L</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 引用类型方法返回一个新的 User 对象，但是对象的属性值都是初始值</span></span><br><span class="line">    User user = userService.getUserInfo(<span class="number">1001L</span>);</span><br><span class="line">    Assert.assertNotNull(user);</span><br><span class="line">    Assert.assertEquals(<span class="number">0L</span>, user.getId());</span><br><span class="line">    Assert.assertNull(user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, user.getAge());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类的静态方法不会被托管</span></span><br><span class="line">    User newUser = UserServiceImpl.newUserInfo(<span class="number">1004L</span>, <span class="string">"zhenchao"</span>, <span class="number">28</span>);</span><br><span class="line">    Assert.assertEquals(<span class="number">1004L</span>, newUser.getId());</span><br><span class="line">    Assert.assertEquals(<span class="string">"zhenchao"</span>, newUser.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">28</span>, newUser.getAge());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自己 new 一个被 mock 类型对象也不会被托管</span></span><br><span class="line">    UserService localService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">    Assert.assertEquals(<span class="string">"zhangsan"</span>, localService.getUserName(<span class="number">1001L</span>));</span><br><span class="line">    Assert.assertEquals(<span class="number">18</span>, localService.getUserAge(<span class="number">1001L</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>总结：</p>
<ol>
<li>注解会创建一个接口的实现类对象，并且仅托管当前创建的实例。</li>
<li>返回值为基本类型的方法直接返回初始值。</li>
<li>返回值为 String 类型的方法直接返回 null。</li>
<li>返回值为引用类型的方法会递归初始化。</li>
<li>构造方法、静态方法不会被托管。</li>
</ol>

        <h5 id="注解：Tested">
          <a href="#注解：Tested" class="heading-link"><i class="fas fa-link"></i></a>注解：Tested</h5>
      <p>注解 <code>@Tested</code> 一般和 <code>@Injectable</code> 配合使用以 mock 被测试类或接口的对象，如果该对象没有被赋值，则 JMockit 会对该对象进行实例化。实例化过程中如果被测试类具备带参数的构造方法，则 JMockit 会尝试在 mock 属性和 mock 参数中寻找被 <code>@Injectable</code> 修饰的 mock 对象进行注入，否则使用无参构造方法进行实例化，并尝试属性注入。</p>
<p>下面以一个订单示例说明注解 <code>@Tested</code> 和 <code>@Injectable</code> 的配合使用。假设有一个订单服务 OrderService，当调用该服务的 <code>OrderService#submitOrder</code> 方法提交订单时需要调用用户服务 UserService 验证当前提交订单用户的密码，只有在密码验证通过的情况下才会处理订单，并在订单处理成功之后调用邮件服务 EmailService 发送邮件通知用户。订单服务实现如下：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 用户服务 */</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 邮件服务 */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EmailService emailService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderService</span><span class="params">(UserService userService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.userService = userService;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提交订单</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户 ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderId 订单 ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password 用户密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果订单提交成功则返回 true，否则返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">submitOrder</span><span class="params">(<span class="keyword">long</span> userId, <span class="keyword">long</span> orderId, String password)</span> </span>{</span><br><span class="line">        <span class="comment">// 校验用户密码</span></span><br><span class="line">        <span class="keyword">if</span> (userService.checkPassword(userId, password)) {</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 密码验证通过，处理订单，省略 ...</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送通知邮件</span></span><br><span class="line">            User user = userService.getUserInfo(userId);</span><br><span class="line">            emailService.send(user.getEmail(), <span class="string">"submit order success"</span>, <span class="string">"submit order success, orderId: "</span> + orderId);</span><br><span class="line">            System.out.println(<span class="string">"user submit order success, userId: "</span> + userId + <span class="string">", orderId: "</span> + orderId);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">        System.out.println(<span class="string">"invalid password, userId: "</span> + userId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OrderService <span class="title">setEmailService</span><span class="params">(EmailService emailService)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.emailService = emailService;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>在订单服务 OrderService 中，我们设定了通过构造方法注入 UserService 实例，通过属性注入 EmailService 实例，相应的测试方法实现如下：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Tested</span></span><br><span class="line"><span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitOrder</span><span class="params">(<span class="meta">@Injectable</span> EmailService emailService)</span> </span>{</span><br><span class="line">    User zhangsan = <span class="keyword">new</span> User(<span class="number">1001L</span>, <span class="string">"zhangsan"</span>, <span class="number">18</span>).setEmail(<span class="string">"zhangsan@gmail.com"</span>).setPassword(<span class="string">"aaa"</span>);</span><br><span class="line">    <span class="keyword">new</span> Expectations() {</span><br><span class="line">        {</span><br><span class="line">            userService.getUserInfo(zhangsan.getId());</span><br><span class="line">            result = zhangsan;</span><br><span class="line"></span><br><span class="line">            userService.checkPassword(zhangsan.getId(), zhangsan.getPassword());</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            emailService.send(zhangsan.getEmail(), anyString, anyString);</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    Assert.assertTrue(orderService.submitOrder(zhangsan.getId(), RandomUtils.nextLong(), zhangsan.getPassword()));</span><br><span class="line">    Assert.assertFalse(orderService.submitOrder(zhangsan.getId(), RandomUtils.nextLong(), <span class="string">""</span>));</span><br><span class="line">    Assert.assertFalse(orderService.submitOrder(<span class="number">1002L</span>, RandomUtils.nextLong(), zhangsan.getPassword()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>我们在测试方法中同时使用了 mock 属性和 mock 参数，并录制了相应服务方法的期望行为，借助 JMockit 可以将这些录制在执行具体测试逻辑时重放。</p>

        <h5 id="注解：Capturing">
          <a href="#注解：Capturing" class="heading-link"><i class="fas fa-link"></i></a>注解：Capturing</h5>
      <p>有时候我们只知道父类或接口，但是希望控制它所有的子类（包括人工编写、匿名类，以及动态代理生成等）的行为，这时可以使用 <code>@Capturing</code> 注解。该注解平时虽然较少用到，但在一些场景下还非它不可，尤其是动态代理相关应用场景。</p>
<p>假设我们现在有一个密码校验服务接口 PasswordService，我们并不知道该接口的实现类有哪些，以及如何实现，可能是匿名类，也可能是动态代理，如下：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PasswordService</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">check</span><span class="params">(<span class="keyword">long</span> userId, String password)</span></span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 匿名类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PasswordService passwordService1 = <span class="keyword">new</span> PasswordService() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">(<span class="keyword">long</span> userId, String password)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1001L</span> != userId &amp;&amp; StringUtils.isNotBlank(password);</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态代理类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PasswordService passwordService2 = (PasswordService) Proxy.newProxyInstance(</span><br><span class="line">        Thread.currentThread().getContextClassLoader(),</span><br><span class="line">        <span class="keyword">new</span> Class[] {PasswordService.class},</span><br><span class="line">        <span class="keyword">new</span> InvocationHandler() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">                <span class="keyword">return</span> args.length == <span class="number">2</span></span><br><span class="line">                        &amp;&amp; (Long) args[<span class="number">0</span>] != <span class="number">1001L</span> &amp;&amp; StringUtils.isNotBlank(String.valueOf(args[<span class="number">1</span>]));</span><br><span class="line">            }</span><br><span class="line">        });</span><br></pre></td></tr></tbody></table></div></figure>
<p>假设我们现在想托管所有 PasswordService 接口的实现类，不管是匿名类还是动态生成的，这个时候就可以使用 <code>@Capturing</code> 注解：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withCapturing</span><span class="params">(<span class="meta">@Capturing</span> PasswordService passwordService)</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> UID = <span class="number">1001L</span>;</span><br><span class="line">    <span class="keyword">new</span> Expectations() {</span><br><span class="line">        {</span><br><span class="line">            passwordService.check(UID, anyString);</span><br><span class="line">            result = <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    <span class="comment">// 不管子类实现如何，全部应用录制的行为</span></span><br><span class="line">    Assert.assertTrue(passwordService1.check(UID, <span class="string">"aaa"</span>));</span><br><span class="line">    Assert.assertTrue(passwordService2.check(UID, <span class="string">"bbb"</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withoutCapturing</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> UID = <span class="number">1001L</span>;</span><br><span class="line">    Assert.assertFalse(passwordService1.check(UID, <span class="string">"aaa"</span>));</span><br><span class="line">    Assert.assertFalse(passwordService2.check(UID, <span class="string">"bbb"</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>由示例可以看出，如果目标接口使用 <code>@Capturing</code> 注解修饰，则不管子类如何实现，都不再生效。</p>
<p><strong>注</strong> ：1.38 版本存在 bug，对于动态代理生成的类无法代理。</p>
<p>上面的示例也可以使用 MockUp 实现，我们会在后面对 MockUp 的使用进行详细介绍，这里先给出一个示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> &lt;T extends PasswordService&gt; <span class="function"><span class="keyword">void</span> <span class="title">mockup</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> UID = <span class="number">1001L</span>;</span><br><span class="line">    <span class="keyword">new</span> MockUp&lt;T&gt;() {</span><br><span class="line">        <span class="meta">@Mock</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">(<span class="keyword">long</span> userId, String password)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    PasswordService passwordService1 = <span class="keyword">new</span> PasswordService() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">(<span class="keyword">long</span> userId, String password)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    Assert.assertTrue(passwordService1.check(UID, <span class="string">"aaa"</span>));</span><br><span class="line"></span><br><span class="line">    PasswordService passwordService2 = (PasswordService) Proxy.newProxyInstance(</span><br><span class="line">            Thread.currentThread().getContextClassLoader(),</span><br><span class="line">            <span class="keyword">new</span> Class[] {PasswordService.class},</span><br><span class="line">            <span class="keyword">new</span> InvocationHandler() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">    Assert.assertTrue(passwordService2.check(UID, <span class="string">"aaa"</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>

        <h3 id="Faking：替换目标方法的实现">
          <a href="#Faking：替换目标方法的实现" class="heading-link"><i class="fas fa-link"></i></a>Faking：替换目标方法的实现</h3>
      <p>MockUp 可以伪造目标方法的实现，以返回我们期望的数据或者行为，其语义与 Expectations 相似，但是更加直观和简单。MockUp 适用于一个项目中对一些通用类的 mock 操作，以减少大量重复的 Exceptations 录制代码。示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mockup</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">new</span> MockUp&lt;UserService&gt;(UserServiceImpl.class) {</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Mock</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUserAge</span><span class="params">(<span class="keyword">long</span> userId)</span> </span>{</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">1001L</span> == userId) {</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">1002L</span> == userId) {</span><br><span class="line">                <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">1003L</span> == userId) {</span><br><span class="line">                <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">    Assert.assertEquals(<span class="number">1</span>, userService.getUserAge(<span class="number">1001L</span>));</span><br><span class="line">    Assert.assertEquals(<span class="number">2</span>, userService.getUserAge(<span class="number">1002L</span>));</span><br><span class="line">    Assert.assertEquals(<span class="number">3</span>, userService.getUserAge(<span class="number">1003L</span>));</span><br><span class="line">    Assert.assertEquals(-<span class="number">1</span>, userService.getUserAge(<span class="number">1004L</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>示例中我们通过组合 MockUp 和 <code>@Mock</code> 注解对 <code>UserServiceImpl#getUserAge</code> 方法进行录制。</p>
<p>如果我们希望像 Expectations 那样对目标方法进行条件性 mock，例如依据参数选择是 mock 还是直接调用原始方法，可以引入 Invocation 对象，实现如下：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mockup</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">new</span> MockUp&lt;UserService&gt;(UserServiceImpl.class) {</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Mock</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">getUserInfo</span><span class="params">(Invocation inv, <span class="keyword">long</span> userId)</span> </span>{</span><br><span class="line">            <span class="keyword">if</span> (userId &gt; <span class="number">1003L</span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> User(userId, <span class="string">"u_"</span> + userId, (<span class="keyword">int</span>) userId % <span class="number">100</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 当 userId 小于等于 1003 时直接调用原始方法</span></span><br><span class="line">            <span class="keyword">return</span> inv.proceed(userId);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">    Assert.assertEquals(UserServiceImpl.REGISTRY.get(<span class="number">1001L</span>), userService.getUserInfo(<span class="number">1001L</span>));</span><br><span class="line">    Assert.assertEquals(UserServiceImpl.REGISTRY.get(<span class="number">1002L</span>), userService.getUserInfo(<span class="number">1002L</span>));</span><br><span class="line">    Assert.assertEquals(UserServiceImpl.REGISTRY.get(<span class="number">1003L</span>), userService.getUserInfo(<span class="number">1003L</span>));</span><br><span class="line">    User user = userService.getUserInfo(<span class="number">1004L</span>);</span><br><span class="line">    Assert.assertEquals(<span class="number">1004L</span>, user.getId());</span><br><span class="line">    Assert.assertEquals(<span class="string">"u_1004"</span>, user.getName());</span><br><span class="line">    Assert.assertEquals(<span class="number">4</span>, user.getAge());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>可以看到相对于 Expectations 而言，MockUp 的条件性 mock 更加简单。</p>
<p>MockUp 使用简单、直观，与 Expectations 形成互补，从而极大增强了 JMockit 的功能，下面将对 MockUp 的常见应用场景进行举例说明，不过在开始之前我们还是先概括一下 MockUp 在使用上的一些限制：</p>
<ol>
<li>无法对单个实例进行 mock。</li>
<li>无法对动态代理类进行 mock。</li>
<li>当需要对类的所有方法进行 mock 时，开发效率较低。</li>
</ol>

        <h4 id="Mock-私有方法和-native-方法">
          <a href="#Mock-私有方法和-native-方法" class="heading-link"><i class="fas fa-link"></i></a>Mock 私有方法和 native 方法</h4>
      <p>Expectations 在 mock 目标类的私有方法和 native 方法时有些力不从心，这个时候可以使用 MockUp 代替，示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>{</span><br><span class="line">    <span class="comment">// native 方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">nativeMethod</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 私有方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">privateMethod</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordByMockUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">new</span> MockUp&lt;MyClass&gt;(MyClass.class) {</span><br><span class="line">        <span class="meta">@Mock</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">privateMethod</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2019</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="meta">@Mock</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">nativeMethod</span><span class="params">()</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2019</span>;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    MyClass mc = <span class="keyword">new</span> MyClass();</span><br><span class="line">    Method privateMethod = MyClass.class.getDeclaredMethod(<span class="string">"privateMethod"</span>);</span><br><span class="line">    privateMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Assert.assertEquals(<span class="number">2019</span>, privateMethod.invoke(mc));</span><br><span class="line">    Assert.assertEquals(<span class="number">2019</span>, mc.nativeMethod());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>

        <h4 id="Mock-构造方法和静态代码块">
          <a href="#Mock-构造方法和静态代码块" class="heading-link"><i class="fas fa-link"></i></a>Mock 构造方法和静态代码块</h4>
      <p>前面介绍的 mock 方式，即使目标类被 JMockit 托管，但是在实例化时还是会调用我们自定义的构造方法对类进行实例化，当遇到一些实现复杂或者不规范的类时，可能会在类实例化的过程中执行大量的操作，比如创建数据库连接等，这个时候我们可能希望将构造方法、静态代码块都 mock 调用，以简化 UT 的开发。这个时候我们就可以使用 MockUp 来达到目的：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Connection connection;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 创建数据库连接</span></span><br><span class="line">            connection = DBSource.getConnection();</span><br><span class="line">        } <span class="keyword">catch</span> (SQLException e) {</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">()</span> </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(<span class="keyword">int</span> port)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mockupInitialization</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">new</span> MockUp&lt;UserService&gt;(UserServiceImpl.class) {</span><br><span class="line">        <span class="meta">@Mock</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> $clinit() {</span><br><span class="line">            <span class="comment">// mock 静态代码块</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Mock</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> $init(<span class="keyword">int</span> port) {</span><br><span class="line">            <span class="comment">// mock 构造方法</span></span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    UserServiceImpl userService = <span class="keyword">new</span> UserServiceImpl(<span class="number">8080</span>);</span><br><span class="line">    Assert.assertEquals(<span class="number">0</span>, userService.getPort());</span><br><span class="line">    Assert.assertNull(UserServiceImpl.getConnection());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>示例中目标类 UserServiceImpl 在初始化时需要创建数据库连接，这是一个耗时且易出错的操作，所以我们将其 mock 掉以简化 UT 的编写。在 MockUp 中使用 <code>$clinit</code> 表示类初始化方法，使用 <code>$init</code> 表示类构造方法，之所以这样命名是因为我们的静态代码块在编译成字节码时会组织在一个名为 <code>$clinit</code> 的方法中，而构造方法在编译成字节码时则使用 <code>$init</code> 作为方法名。</p>

        <h4 id="织入切面增强">
          <a href="#织入切面增强" class="heading-link"><i class="fas fa-link"></i></a>织入切面增强</h4>
      <p>MockUp 还允许定义另外一类名为 <code>$advice</code> 的方法，用于实现切面增强的目的，示例：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">advice</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">new</span> MockUp&lt;UserService&gt;(UserServiceImpl.class) {</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Mock</span></span><br><span class="line">        <span class="keyword">public</span> Object $advice(Invocation inv) {</span><br><span class="line">            <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">            Object result = inv.proceed();</span><br><span class="line">            System.out.println(<span class="string">"time elapse: "</span> + (System.nanoTime() - start));</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    UserService userService = <span class="keyword">new</span> UserServiceImpl();</span><br><span class="line">    Assert.assertEquals(UserServiceImpl.REGISTRY.get(<span class="number">1002L</span>), userService.getUserInfo(<span class="number">1002L</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>示例中我们在目标方法前后添加了时间打点，用于记录目标方法的执行时间。</p>

        <h3 id="集成-Spring-框架">
          <a href="#集成-Spring-框架" class="heading-link"><i class="fas fa-link"></i></a>集成 Spring 框架</h3>
      <p>对于 java 服务端应用来说，Spring 基本上算是必备框架，如果我们希望 mock 被 spring 创建的 bean，可以实现如下：</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(locations = "classpath:spring.xml")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringMockTest</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordByExpectations</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">new</span> Expectations(userService) {</span><br><span class="line">            {</span><br><span class="line">                userService.getUserName(anyLong);</span><br><span class="line">                result = <span class="string">"zhenchao"</span>;</span><br><span class="line"></span><br><span class="line">                userService.getUserAge(anyLong);</span><br><span class="line">                result = <span class="number">28</span>;</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        Assert.assertEquals(<span class="string">"zhenchao"</span>, userService.getUserName(<span class="number">1001L</span>));</span><br><span class="line">        Assert.assertEquals(<span class="number">28</span>, userService.getUserAge(<span class="number">1001L</span>));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordByMockup</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">new</span> MockUp&lt;UserService&gt;(UserServiceImpl.class) {</span><br><span class="line">            <span class="meta">@Mock</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">(<span class="keyword">long</span> userId)</span> </span>{</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"zhenchao"</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Mock</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUserAge</span><span class="params">(<span class="keyword">long</span> userId)</span> </span>{</span><br><span class="line">                <span class="keyword">return</span> <span class="number">28</span>;</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">        Assert.assertEquals(<span class="string">"zhenchao"</span>, userService.getUserName(<span class="number">1001L</span>));</span><br><span class="line">        Assert.assertEquals(<span class="number">28</span>, userService.getUserAge(<span class="number">1001L</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>示例中分别实现了基于 Expectations 的录制和基于 MockUp 的录制。</p>

        <h3 id="参考">
          <a href="#参考" class="heading-link"><i class="fas fa-link"></i></a>参考</h3>
      <ul>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://jmockit.github.io/">JMockit 官网文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://jmockit.cn/index.htm">JMockit 中文网</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://plotor.github.io">zhenchao</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://plotor.github.io/2019/01/14/java/jmockit/">https://plotor.github.io/2019/01/14/java/jmockit/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://plotor.github.io/tags/JMockit/">JMockit</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2019/01/31/java/cas-based-concurrent-hashmap/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">基于 CAS 机制的 ConcurrentHashMap 实现内幕</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2019/01/01/java/cglib-guide/"><span class="paginator-prev__text">CGLib：The Missing Guide</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="utterances-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%95%E5%88%B6-amp-%E9%87%8D%E6%94%BE-amp-%E9%AA%8C%E8%AF%81"><span class="toc-number">1.</span> <span class="toc-text">
          录制 &amp; 重放 &amp; 验证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BD%95%E5%88%B6%EF%BC%9AExpectations"><span class="toc-number">1.1.</span> <span class="toc-text">
          录制：Expectations</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E5%A4%96%E9%83%A8-mock-%E7%B1%BB%E6%88%96%E6%8E%A5%E5%8F%A3%E5%AE%9E%E4%BE%8B%E8%BF%9B%E8%A1%8C%E5%BD%95%E5%88%B6"><span class="toc-number">1.1.1.</span> <span class="toc-text">
          引用外部 mock 类或接口实例进行录制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E6%B3%A8%E5%85%A5%E7%B1%BB%E6%88%96%E5%AF%B9%E8%B1%A1%E5%AE%9E%E4%BE%8B%E8%BF%9B%E8%A1%8C%E5%BD%95%E5%88%B6"><span class="toc-number">1.1.2.</span> <span class="toc-text">
          通过构造方法注入类或对象实例进行录制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BD%95%E5%88%B6%E5%A4%9A%E4%B8%AA%E6%9C%9F%E6%9C%9B%E6%97%B6%E5%BA%8F%E7%BB%93%E6%9E%9C"><span class="toc-number">1.1.3.</span> <span class="toc-text">
          录制多个期望时序结果</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%80%A7%E5%BD%95%E5%88%B6"><span class="toc-number">1.1.4.</span> <span class="toc-text">
          条件性录制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%81%B5%E6%B4%BB%E7%9A%84%E5%8F%82%E6%95%B0%E5%8C%B9%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc-number">1.1.5.</span> <span class="toc-text">
          灵活的参数匹配策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BD%95%E5%88%B6%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%AC%A1%E6%95%B0%E9%99%90%E5%88%B6"><span class="toc-number">1.1.6.</span> <span class="toc-text">
          录制方法调用次数限制</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%EF%BC%9AVerifications"><span class="toc-number">1.2.</span> <span class="toc-text">
          验证：Verifications</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.2.1.</span> <span class="toc-text">
          限制方法的调用顺序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%BA%E5%88%B6%E9%AA%8C%E8%AF%81%E6%89%80%E6%9C%89%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.2.</span> <span class="toc-text">
          强制验证所有测试方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7%E9%87%8D%E6%94%BE%E9%98%B6%E6%AE%B5%E7%9A%84%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0"><span class="toc-number">1.2.3.</span> <span class="toc-text">
          捕获重放阶段的方法参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mocking%EF%BC%9A%E6%A8%A1%E6%8B%9F%E6%B5%8B%E8%AF%95%E6%89%80%E4%BE%9D%E8%B5%96%E7%9A%84%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">
          Mocking：模拟测试所依赖的运行环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Mock-%E6%B3%A8%E8%A7%A3%E7%9A%84%E7%89%B9%E7%82%B9%E4%B8%8E%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.1.</span> <span class="toc-text">
          Mock 注解的特点与使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%EF%BC%9AMocked"><span class="toc-number">2.1.1.</span> <span class="toc-text">
          注解：Mocked</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E9%A5%B0%E6%8E%A5%E5%8F%A3%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">
          修饰接口类型</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E9%A5%B0%E7%B1%BB%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">
          修饰类类型</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%EF%BC%9AInjectabe"><span class="toc-number">2.1.2.</span> <span class="toc-text">
          注解：Injectabe</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%EF%BC%9ATested"><span class="toc-number">2.1.3.</span> <span class="toc-text">
          注解：Tested</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%EF%BC%9ACapturing"><span class="toc-number">2.1.4.</span> <span class="toc-text">
          注解：Capturing</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Faking%EF%BC%9A%E6%9B%BF%E6%8D%A2%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">
          Faking：替换目标方法的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Mock-%E7%A7%81%E6%9C%89%E6%96%B9%E6%B3%95%E5%92%8C-native-%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.</span> <span class="toc-text">
          Mock 私有方法和 native 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mock-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E5%92%8C%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E5%9D%97"><span class="toc-number">3.2.</span> <span class="toc-text">
          Mock 构造方法和静态代码块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%87%E5%85%A5%E5%88%87%E9%9D%A2%E5%A2%9E%E5%BC%BA"><span class="toc-number">3.3.</span> <span class="toc-text">
          织入切面增强</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90-Spring-%E6%A1%86%E6%9E%B6"><span class="toc-number">4.</span> <span class="toc-text">
          集成 Spring 框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">
          参考</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/author.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">追求技术深度，注重文章质量</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/plotor" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://weibo.com/" target="_blank" rel="noopener" data-popover="微博" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weibo"></i></span></a><a class="sidebar-ov-social-item" href="null" target="_blank" rel="noopener" data-popover="微信" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weixin"></i></span></a><a class="sidebar-ov-social-item" href="null" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="https://twitter.com/" target="_blank" rel="noopener" data-popover="Twitter" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-twitter"></i></span></a></div><div class="sidebar-ov-feed"><span class="sidebar-ov-feed-rss"><a class="sidebar-ov-feed-rss__link" href="/atom.xml" target="_blank" rel="noopener"><span class="sidebar-ov-feed-rss__icon"><i class="fas fa-rss"></i></span><span>RSS 订阅</span></a></span></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">95</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">13</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">27</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2015~2024</span><span class="footer__devider"></span><span>Zhenchao All Rights Reserved</span><span class="footer__devider">|</span><span>浙ICP备 16010916 号</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.3.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.1</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', function () {
  var pjax = new Pjax({"selectors":["head title","#main",".pjax-reload",".header-inner"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    $('.header-nav-menu').removeClass('show');
    if (CONFIG.pjax && CONFIG.pjax.avoidBanner) {
      $('html').velocity('scroll', {
        duration: 500,
        offset: $('#header').height(),
        easing: 'easeInOutCubic'
      });
    }

    var loadingBarWidth = 20;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar').addClass('loading');
    $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 3;
      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }
      $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    }, 500);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar__progress').css('width', '100%');
    $('.loading-bar').removeClass('loading');
    setTimeout(function () {
      $('.loading-bar__progress').css('width', '0');
    }, 400);
    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });
    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    if (Stun.utils.pjaxReloadBoot) {
      Stun.utils.pjaxReloadBoot();
    }
    if (Stun.utils.pjaxReloadScroll) {
      Stun.utils.pjaxReloadScroll();
    }
    if (Stun.utils.pjaxReloadSidebar) {
      Stun.utils.pjaxReloadSidebar();
    }
    if (true) {
      if (Stun.utils.pjaxReloadHeader) {
        Stun.utils.pjaxReloadHeader();
      }
      if (Stun.utils.pjaxReloadScrollIcon) {
        Stun.utils.pjaxReloadScrollIcon();
      }
      if (Stun.utils.pjaxReloadLocalSearch) {
        Stun.utils.pjaxReloadLocalSearch();
      }
    }
  }, false);
}, false);</script><div id="pjax-reload"></div><script data-pjax="">function loadUtterances() {
  var d = document, s = d.createElement('script');
  var container = d.getElementById('utterances-container');

  if (!container) {
    return;
  }
  s.src = 'https://utteranc.es/client.js';
  s.setAttribute('repo', 'plotor/hexo-comments');
  s.setAttribute('issue-term', 'title');
  s.setAttribute('label', 'utterances');
  s.setAttribute('theme', 'github-light');
  s.setAttribute('crossorigin', 'anonymous');
  s.setAttribute('async', '');
  if (true) {
    s.setAttribute('data-pjax-rm', '');
  }
  container.append(s);
}

if (true) {
  loadUtterances();
} else {
  window.addEventListener('DOMContentLoaded', loadUtterances, false);
}</script><script src="/js/utils.js?v=2.6.1"></script><script src="/js/stun-boot.js?v=2.6.1"></script><script src="/js/scroll.js?v=2.6.1"></script><script src="/js/header.js?v=2.6.1"></script><script src="/js/sidebar.js?v=2.6.1"></script><script type="application/json" src="/search.json"></script></body></html>